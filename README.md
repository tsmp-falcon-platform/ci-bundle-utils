# ci-bundle_utils

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
## Contents

- [Intro](#intro)
- [Fetch](#fetch)
- [Transform](#transform)
- [Example](#example)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Intro

Initial project to provide some nice bundle utility features.

Contains two main commands:

- `fetch` to fetch the exported bundle from a given controller URL, zip file, or text file.
- `transform` to transform the exported bundle according to one or more transformation configurations.

## Fetch

The `fetch` command can fetch an exported bundle and split it up into the appropriate bundle structure.

```sh
❯ bundle_utils fetch --help
Usage: bundle_utils fetch [OPTIONS]

Options:
  -l, --log-level TEXT   The log level (or use BUNDLE_UTILS_LOG_LEVEL).
  -P, --path TEXT        The path to fetch YAML from (or use
                         BUNDLE_UTILS_PATH).
  -U, --url TEXT         The URL to fetch YAML from (or use BUNDLE_UTILS_URL).
  -u, --username TEXT    Username for basic authentication (or use
                         BUNDLE_UTILS_USERNAME).
  -p, --password TEXT    Password for basic authentication (or use
                         BUNDLE_UTILS_PASSWORD).
  -t, --target-dir TEXT  The target directory for the YAML documents (or use
                         BUNDLE_UTILS_TARGET_DIR).
  --help                 Show this message and exit.
```

## Transform

The `transform` command can transform a fetched bundle according to a configuration based upon:

- `patches` - a set of patches as shown by https://jsonpatch.com/
- `credentials` - the ability to replace encrypted credentials with a given or autogenerated text
- `splits` - split configuration files (typically `items.yaml` or `jenkins.yaml`) into smaller chunked configuration files.

It can take multiple transformation files which it merges together before applying.

```sh
❯ bundle_utils transform --help
Usage: bundle_utils transform [OPTIONS]

Options:
  -l, --log-level TEXT   The log level (or use BUNDLE_UTILS_LOG_LEVEL).
  -c, --config TEXT      The transformation config(s) (or use
                         BUNDLE_UTILS_TRANSFORMATION).  [required]
  -s, --source-dir TEXT  The source directory for the YAML documents (or use
                         BUNDLE_UTILS_TARGET_DIR).
  -t, --target-dir TEXT  The target directory for the YAML documents (or use
                         BUNDLE_UTILS_TARGET_DIR). Defaults to the source
                         directory suffixed with -transformed.
  --help                 Show this message and exit.
```

## Example

Create a docker image:

```sh
docker buildx build -t bundle-utils:dev .
```

Create a temporary container:

```sh
docker run -u $(id -u):$(id -g) --rm -it bundle-utils:dev bash
```

Fetch an exported bundle:

```sh
bundle-user@89f38e7b7f8c:/app$ bundle_utils fetch --path examples/bundlecontent.yaml
INFO:root:Wrote target/docs/bundle.yaml
INFO:root:Wrote target/docs/jenkins.yaml
INFO:root:Wrote target/docs/plugins.yaml
INFO:root:Wrote target/docs/rbac.yaml
INFO:root:Wrote target/docs/items.yaml
```

Transform the bundle:

```sh
bundle-user@89f38e7b7f8c:/app$ bundle_utils transform -c examples/transformations.yaml -s target/docs
INFO:root:Processing config: examples/transformations.yaml
INFO:root:Applying patch to target/docs-transformed/jenkins.yaml
INFO:root:Applying JSON patch to target/docs-transformed/jenkins.yaml
INFO:root:Applying JSON patch to target/docs-transformed/jenkins.yaml
INFO:root:Applying patch to target/docs-transformed/bundle.yaml
INFO:root:Applying JSON patch to target/docs-transformed/bundle.yaml
...
...
INFO:root:Loading existing target file target/docs-transformed/jenkins.kubernetes.yaml
INFO:root:Saving target file target/docs-transformed/jenkins.kubernetes.yaml
INFO:root:Writing bundle to target/docs-transformed/bundle.yaml
```

Check the changes:

```sh
bundle-user@89f38e7b7f8c:/app$ find target/docs-transformed
target/docs-transformed
target/docs-transformed/items.casc-test-1.yaml
target/docs-transformed/jenkins.controllerLifecycleNotifications.yaml
target/docs-transformed/items.casc-test-2.yaml
target/docs-transformed/items.yaml
target/docs-transformed/jenkins.beekeeper.yaml
target/docs-transformed/items.controllers.yaml
target/docs-transformed/jenkins.cloudBeesCasCServer.yaml
target/docs-transformed/jenkins.jenkins.clouds.yaml
target/docs-transformed/items.admin.yaml
target/docs-transformed/plugins.yaml
target/docs-transformed/bundle.yaml
target/docs-transformed/jenkins.yaml
target/docs-transformed/jenkins.credentials.yaml
target/docs-transformed/jenkins.advisor.yaml
target/docs-transformed/jenkins.support.yaml
target/docs-transformed/rbac.yaml
target/docs-transformed/jenkins.kubernetes.yaml
```

The `bundle.yaml` has been updated to reflect the new structure and the version is based on the md5sum of all files.

```sh
bundle-user@89f38e7b7f8c:/app$ cat target/docs-transformed/bundle.yaml 
apiVersion: '1'
id: base
description: This is an autogenerated bundle from the base transformation
version: 84f13a8ff6e30e59639ea266456dc64e
jcasc:
- jenkins.yaml
- jenkins.advisor.yaml
- jenkins.beekeeper.yaml
- jenkins.cloudBeesCasCServer.yaml
- jenkins.controllerLifecycleNotifications.yaml
- jenkins.credentials.yaml
- jenkins.jenkins.clouds.yaml
- jenkins.kubernetes.yaml
- jenkins.support.yaml
plugins:
- plugins.yaml
rbac:
- rbac.yaml
items:
- items.yaml
- items.admin.yaml
- items.casc-test-1.yaml
- items.casc-test-2.yaml
- items.controllers.yaml
```
